name: GitHub release and Publish to NPM
description: Create a GitHub release and publish to NPM

inputs:
  github-token:
    required: true
    description: 'The GitHub token to use for authentication'
  release-tag:
    required: true
    description: 'The tag to use for the release'
  draft:
    required: false
    description: 'Whether to create a draft (unpublished) release'
    default: 'true'
  prerelease:
    required: false
    description: 'Whether to create a prerelease release'
    default: 'true'

runs:
  using: 'composite'
  steps:
    # Replace with DevCycleHQ/release-action/gh-release@main when it's ready
    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      id: create_release
      with:
        name: "${{ inputs.release-tag }}"
        tag: "${{ inputs.release-tag }}"
        generateReleaseNotes: "true"
        makeLatest: "true"
        token: ${{ inputs.github-token }}
        draft: ${{ inputs.draft }}
        prerelease: ${{ inputs.prerelease }}

    - name: Build Artifacts
      uses: ./.github/actions/build-artifacts
      with:
        upload-url: ${{ steps.create_release.outputs.upload_url }}
        release-tag: ${{ env.LATEST_TAG }}
        
    - name: Set up Node.js for npm publish
      uses: actions/setup-node@v4
      with:
        registry-url: "https://registry.npmjs.org"
        scope: "@devcycle"

    - name: Update npm for OIDC support
      shell: bash
      run: npm install -g npm@11.6.2

    - name: Verify npm version for OIDC
      shell: bash
      run: |
        npm_version=$(npm --version)
        echo "npm version: $npm_version"
        if [ "$(printf '%s\n' "11.6.2" "$npm_version" | sort -V | head -n1)" != "11.6.2" ]; then
          echo "Error: npm version $npm_version is below 11.6.2 required for OIDC trusted publishing"
          exit 1
        fi

    - name: Publish to NPM
      shell: bash
      run: npm publish --access public
