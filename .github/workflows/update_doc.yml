name: Update Doc

on:
  workflow_run:
    workflows:
      - "CLI Release"
    types:
      - completed

jobs:
  update_doc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write 
    steps:      
      - name: Check out code
        uses: actions/checkout@v3
        with:
          repository: DevCycleHQ/devcycle-docs
          # need to get/update access token
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Get latest tag
        id: get_latest_tag
        run: echo "LATEST_TAG=$(git describe --abbrev=0 --tags)" >> $GITHUB_OUTPUT      

      - name: Update CLI version in docs repo
        env: 
          CLI_VERSION: v${{ steps.get_latest_tag.outputs.LATEST_TAG }}
          BRANCH_NAME: update-cli-version-to-${{ env.CLI_VERSION }}
        run: |
          git checkout -b "$BRANCH_NAME"
          sed -i 's/const DVC_CLI_VERSION = .*/const DVC_CLI_VERSION = '\''$CLI_VERSION'\'' \/\/ auto updated by dvc cli release workflow/' docusaurus.config.js
          git add docusaurus.config.js
          git commit -m "Update CLI version to $CLI_VERSION"

      - name: Push code to docs repo
        run:  |
          git push --set-upstream origin "$BRANCH_NAME"

      - name: Create PR
        env:
        # need to get/update access token
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          CLI_VERSION: v${{ steps.get_latest_tag.outputs.LATEST_TAG }}
          BRANCH_NAME: update-cli-version-to-${{ env.CLI_VERSION }}
        run: gh pr create --repo DevCycleHQ/devcycle-docs --base main --head "$BRANCH_NAME" --title "Update CLI version to $CLI_VERSION" --body "This PR was automatically created by the DevCycle CLI release workflow."